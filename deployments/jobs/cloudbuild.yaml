steps:
- name: 'gcr.io/cloud-builders/docker'
  args: [ 'build', '-f', 'deployments/worker/Dockerfile', '-t', 'gcr.io/$PROJECT_ID/worker:$COMMIT_SHA', '.' ]
- name: 'gcr.io/cloud-builders/docker'
  args: ['push', 'gcr.io/$PROJECT_ID/worker:$COMMIT_SHA']
- name: 'gcr.io/cloud-builders/kubectl'
  entrypoint: bash
  args:
    - '-c'
    - |
      sed -e "s|_COMMIT_SHA|$COMMIT_SHA|g" deployments/worker/template.yaml | tee deployment.yaml
      gcloud container clusters get-credentials --project="skynet-1984" --zone="us-central1-a" "virgo"
      cat worker.yaml
      kubectl apply -f - <deployment.yaml
  env:
    - 'CLOUDSDK_COMPUTE_ZONE=us-central1-a'
    - 'CLOUDSDK_CONTAINER_CLUSTER=virgo'
